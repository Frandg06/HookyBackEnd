# nixpacks.toml

# 1. Definimos las variables de entorno
[variables]
    PHP_INI_SCAN_DIR = ":/app/.config/php"

# 2. Configuración del sistema (Paquetes y memoria)
[phases.setup]
    nixPkgs = [
        "php83",
        "php83Extensions.redis",      # <--- ESTO ARREGLA EL ERROR "Class Redis not found"
        "php83Extensions.gd",         # Requerido por intervention/image
        "php83Extensions.pdo_mysql",  # Base de datos
        "php83Extensions.bcmath",
        "php83Extensions.zip",
        "php83Extensions.intl",
        "php83Extensions.xml",
        "php83Extensions.curl",
        "php83Extensions.mbstring",
        "git",
        "unzip"
    ]
    
    # Creamos el archivo para memoria ilimitada
    cmds = [
        "mkdir -p /app/.config/php",
        "echo 'memory_limit = -1' > /app/.config/php/memory.ini"
    ]

# 3. Instalación de dependencias de PHP (Sin Node)
[phases.install]
    cmds = [
        "composer install --ignore-platform-reqs --no-dev --optimize-autoloader"
    ]

# 4. Build (Laravel suele requerir cachear config)
[phases.build]
    cmds = [
        "php artisan config:cache",
        "php artisan event:cache",
        "php artisan route:cache"
    ]

# 5. Comando de arranque
[start]
    cmd = "php artisan serve --host=0.0.0.0 --port=$PORT"